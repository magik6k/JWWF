<!DOCTYPE html>
<html>
	<head>
		<title>JavaWebWidgetFrmework</title>
		<meta charset="UTF-8">
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script>
			//Config
			
			var apiServer = "ws://localhost:8888";
			
			//Confing end
			
			
			var widgetStorage = [];
			var widgets = {};
			var socket;
			
			function sendButton(id){
				socket.send("B"+id);
			}
			
			function sendText(id,text){
				socket.send("T"+id+";"+text);
				console.log("T"+id+";"+text);
			}
			
			//WIDGET IMPLEMENTATIONS
			
			widgets["MainFrame"] = {
				create: function(data){
					if(data.content < 0)
						return {element: $("body")};
					
					$("body").html(widgetStorage[data.content].element);
					return {element: $("body")};
				},
				update: function(widget, data){
					if(data.content < 0)
					{
						$("body").html("");
					}
					else
					{
						$("body").html(widgetStorage[data.content].element);
					}
				}
			};//MainFrame end
			
			widgets["FixedPanel"] = {
				create: function(data){
					if(data.content < 0)
						return {element: $("<div>").css({left:data.x,top:data.y})};
					
					var elem = $("<div>").html(widgetStorage[data.content].element)
						.css({left:data.x,top:data.y}).addClass("fixedPanel");
					return {element: elem};
				},
				update: function(widget, data){
					if(data.content < 0)
					{
						$(widget.element).html("").css({left:data.x,top:data.y});
					}
					else
					{
						$(widget.element).html(widgetStorage[data.content].element)
							.css({left:data.x,top:data.y});
					}
				}
			};//FixedPanel end
			
			widgets["AbsolutePanel"] = {
				create: function(data){
					if(data.content < 0)
						return {element: $("<div>").css({left:data.x,top:data.y})};
					
					var elem = $("<div>").html(widgetStorage[data.content].element)
						.css({left:data.x,top:data.y}).addClass("absolutePanel");
					return {element: elem};
				},
				update: function(widget, data){
					if(data.content < 0)
					{
						$(widget.element).html("").css({left:data.x,top:data.y});
					}
					else
					{
						$(widget.element).html(widgetStorage[data.content].element)
							.css({left:data.x,top:data.y});
					}
				}
			};//AbsolutePanel end
			
			widgets["HorizontalPanel"] = {
				create: function(data){
					var elements = []; 
					var elem = $("<div>");
					
					for(var i = 0; i < data.content.length; ++i)
					{
						if(data.content[i] < 0)
						{
							elements[i] = $("<div>").addClass("vertical");
						}
						else
						{
							elements[i] = $("<div>").addClass("vertical")
								.html(widgetStorage[data.content[i]].element);
						}
						elem.append(elements[i])
					}
					
					return {element: elem, data: {elements: elements}};
				},
				update: function(widget, data){
					//TODO: Implement!
				}
					
			};//HorizontalPanel end
			
			widgets["VerticalPanel"] = {
				create: function(data){
					var elements = []; 
					var elem = $("<div>");
					
					for(var i = 0; i < data.content.length; ++i)
					{
						if(data.content[i] < 0)
						{
							elements[i] = $("<div>");
						}
						else
						{
							elements[i] = $("<div>")
								.html(widgetStorage[data.content[i]].element);
						}
						elem.append(elements[i])
					}
					
					return {element: elem, data: {elements: elements}};
				},
				update: function(widget, data){
					//TODO: Implement!
				}
					
			};//VerticalPanel end
			
			widgets["TablePanel"] = {
				create: function(data){
					var rows = []; 
					var elem = $("<table>");
					
					for(var i = 0; i < data.content.length; ++i)
					{
						rows[i] = $("<tr>")
						for(var j = 0; j < data.content[i].length; ++j)
						{
							if(data.content[i][j] < 0)
							{
								$(rows[i]).append($("<td>"));
							}
							else
							{
								$(rows[i]).append($("<td>").html(widgetStorage[data.content[i][j]].element));
							}
						}
						elem.append(rows[i]);
					}
					
					return {element: elem, data: {rows: rows}};
				},
				update: function(widget, data){
					//TODO: Implement!
				}
					
			};//TablePanel end
			
			
			widgets["TextLabel"] = {
				create: function(data){
					return {element: $("<span>").html(data.text)};
				},
				update: function(widget, data){
					$(widget.element).html(data.text);
				}
					
			};//TextLabel end
			
			widgets["Image"] = {
				create: function(data){
					return {element: $("<img>").attr("src",data.url)
						.css("width",data.size[0]<0?"auto":(data.size[0]+"px"))
						.css("height",data.size[1]<0?"auto":(data.size[1]+"px"))};
				},
				update: function(widget, data){
					$(widget.element).attr("src",data.url)
						.css("width",data.size[0]<0?"auto":(data.size[0]+"px"))
						.css("height",data.size[1]<0?"auto":(data.size[1]+"px"));
				}
					
			};//Image end
			
			widgets["ExternalLink"] = {
				create: function(data){
					return {element: $("<a>").html(data.label).attr("href", data.url)};
				},
				update: function(widget, data){
					$(widget.element).html(data.label).attr("href", data.url);
				}
					
			};//ExternalLink end
			
			widgets["InternalLink"] = {
				create: function(data,id){
					return {element: $("<a>").html(data.label)
						.attr("href","javascript:void(0);").click(function(){sendButton(id)})};
				},
				update: function(widget, data){
					$(widget.element).html(data.label);
				}
					
			};//InternalLink end
			
			widgets["Button"] = {
				create: function(data,id){
					return {element: $("<button>").html(data.label)
					.click(function(){sendButton(id)})};
				},
				update: function(widget, data){
					$(widget.element).html(data.label);
				}
					
			};//Button end
			
			widgets["TextInput"] = {
				create: function(data,id){
					var snd = 0;
					
					var elem = $("<input>").attr("type","text")
						.attr("placeholder", data.text)
						.on("keypress",function(){ 
								clearTimeout(snd);
								snd = setTimeout(function(){
									sendText(id,$(elem).val());
								},250);
							});
					return {element: elem};
				},
				update: function(widget, data){
					$(widget.element).attr("placeholder", data.text);
				}
					
			};//TextInput end
			
			widgets["PasswordInput"] = {
				create: function(data,id){
					var snd = 0;
					
					var elem = $("<input>").attr("type","password")
						.attr("placeholder", data.text)
						.on("keypress",function(){ 
								clearTimeout(snd);
								snd = setTimeout(function(){
									sendText(id,$(elem).val());
								},250);
							});
					return {element: elem};
				},
				update: function(widget, data){
					$(widget.element).attr("placeholder", data.text);
				}
					
			};//PasswordInput end
			
			//WIDGET IMPLEMENTATIONS END
			
			$(function(){
				socket = new WebSocket(apiServer);
				
				socket.onopen = function()
				{
					$("title").html("JavaWebWidgetFrmework - connected");
				};
				socket.onmessage = function (event) 
				{ 
					var data = JSON.parse(event.data);
					console.log(data);
					if(widgetStorage[data.id] == undefined)
					{
						widgetStorage[data.id] = widgets[data.type].create(data.data,data.id);
					}
					else
					{
						widgets[data.type].update(widgetStorage[data.id], data.data);
					}
				};
				socket.onclose = function()
				{ 
					alert("Connection closed"); 
				};
			});
		</script>
		<style>
			.vertical{display: inline-block;}
			.fixedPanel{position: fixed;}
			.absolutePanel{position: absolute;}
		</style>
	</head>
	<body>
		
	</body>
</html>
